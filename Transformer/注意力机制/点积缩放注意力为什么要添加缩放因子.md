# 点积缩放注意力为什么要添加缩放因子

### **设定一个具体例子**
假设：
- **键的维度**：\(d_k = 3\)（即每个 Query 和 Key 的向量是3维）。
- **Query 向量**：\(q = [q_1, q_2, q_3]\)
- **Key 向量**：\(k = [k_1, k_2, k_3]\)

根据假设：
- 每个维度 \(q_i\) 和 \(k_i\) 是**独立随机变量**，且均值为0、方差为1（例如标准正态分布 \(N(0,1)\)）。

---

### **步骤1：计算点积 \(q \cdot k\)**
点积公式为：
\[
q \cdot k = q_1 k_1 + q_2 k_2 + q_3 k_3
\]

**随机采样值**：
- \(q_1 = 0.5\), \(k_1 = -0.7\)
- \(q_2 = -0.3\), \(k_2 = 0.4\)
- \(q_3 = 1.2\), \(k_3 = 0.9\)

**计算结果**：
\[
q \cdot k = (0.5)(-0.7) + (-0.3)(0.4) + (1.2)(0.9) = -0.35 -0.12 + 1.08 = 0.61
\]

---

### **步骤2：计算点积的方差**
从统计角度分析点积的方差：

#### **单个项 \(q_i k_i\) 的方差**
对任意维度 \(i\)，乘积的方差为：
\[
\text{Var}(q_i k_i) = \text{Var}(q_i) \cdot \text{Var}(k_i) = 1 \times 1 = 1
\]

#### **总方差**
点积是三个独立项的和，总方差为：
\[
\text{Var}(q \cdot k) = \sum_{i=1}^{3} \text{Var}(q_i k_i) = 1 + 1 + 1 = 3 = d_k
\]

---

### **步骤3：缩放后的点积方差**
将点积结果除以 \(\sqrt{d_k} = \sqrt{3}\)：
\[
\frac{q \cdot k}{\sqrt{3}} = \frac{0.61}{\sqrt{3}} \approx 0.35
\]

#### **缩放后的方差**
根据方差缩放性质：
\[
\text{Var}\left(\frac{X}{c}\right) = \frac{\text{Var}(X)}{c^2}
\]
因此，缩放后的方差为：
\[
\text{Var}\left(\frac{q \cdot k}{\sqrt{3}}\right) = \frac{3}{(\sqrt{3})^2} = \frac{3}{3} = 1
\]

==**所以除以 $\sqrt{d_k}$ 就是为了让方差归一化**==

---

### 为何要归一化方差？

假设有 5 门课: 语文、数学、英语、物理、化学

每门课老师批改卷子时，打分规则不一样

- 语文: 0~10，6分及格
- 数学: 0~100，60分及格
- 英语: 0~1000，600分及格
- 物理: 0~10000，6000分及格
- 化学: 0~100000，60000分及格

假设我们要训练一个模型，用于判断这个学生最擅长哪个学科，此处考虑用多分类问题 softmax 进行激活，求概率分布，则逻辑如下:

假设一个学生的每科分数为 [10, 80, 500, 4000, 20000]，则各学科的权重比为:

- 总分: $10 + 100 + 1000 + 10000 + 100000 = 111110$
- 语文: $10 / 111110 \approx 0.00009$
- 数学: $80 / 111110 \approx 0.00072$
- 英语: $500 / 111110 \approx 0.0045$
- 物理: $4000 / 111110 \approx 0.036$
- 化学: $20000 / 111110 \approx 0.18$

==**可以看到，明明语文得了满分，但是对于总分的贡献极低**==

此时若进行 softmax 激活，则语文的占比将极小，那么反向传播时，梯度将消失，模型将无法学习到学生语文学得到底好还是不好。

**造成此问题的原因正是因为每个评分老师的标准不同**

所以我们需要统一标准

反映到点积注意力上就是添加一个缩放比例，让方差归一化，则每个老师的评分标准将变为 -1~1 之间。从而解决部分特征梯度消失，无法学习的问题。

### **直观总结**
- 除以 $\sqrt{dk}$ 可以归一化点积相似度的方差，使得方差变成 -1~1
- 可以缓解 softmax 分母极大，而分子极小时的梯度消失